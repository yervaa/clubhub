{% extends "layout.html" %}

{% block title %}Manage Members - {{ club.name }}{% endblock %}

{% block main %}
  <div class="page-header">
    <div>
      <h1>Manage Members — {{ club.name }}</h1>
      <p class="page-subtitle mb-0">Assign roles and share the join code</p>
    </div>
    <a class="btn btn-outline" href="/clubs/{{ club.id }}/roles">Roles & Permissions</a>
  </div>

  {% if can_manage_join_code %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-bold">Join code</div>
        <code class="fs-6">{{ club.join_code }}</code>
      </div>
      <form method="post" action="/clubs/{{ club.id }}/join_code/regenerate" class="ms-3">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
        <button class="btn btn-sm btn-outline-primary" type="submit">Regenerate</button>
      </form>
    </div>
  {% endif %}

  <section class="card mb-4">
    <div class="card-body">
      <form method="post">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="page" value="{{ page }}">
        <div class="form-group">
          <label for="user_id" class="form-label">User</label>
          <select id="user_id" name="user_id" class="form-select" required>
            <option value="">Select a user</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.username }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="role" class="form-label">Role</label>
          <select id="role" name="role_id" class="form-select">
            <option value="">Select role</option>
            {% for r in roles %}
              <option value="{{ r.id }}">{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="btn btn-primary w-100">Save Member</button>
      </form>
    </div>
  </section>

  <section>
    <h3 class="mb-3">Current Members</h3>
    {% if members %}
      <div class="list-group">
        {% for m in members %}
          <div class="list-group-item d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <strong>{{ m.username }}</strong>
              <div class="small muted">Role: {{ m.role_name }}</div>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <form method="post" class="d-flex gap-2 align-items-center">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="page" value="{{ page }}">
                <input type="hidden" name="user_id" value="{{ m.user_id }}">
                <select class="form-select form-select-sm" name="role_id">
                  {% for r in roles %}
                    <option value="{{ r.id }}" {% if r.id == m.role_id %}selected{% endif %}>{{ r.name }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-sm btn-outline-primary">Update</button>
              </form>
              <form method="post" action="/clubs/{{ club.id }}/members/remove" onsubmit="return confirm('Remove member?');">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="page" value="{{ page }}">
                <input type="hidden" name="user_id" value="{{ m.user_id }}">
                <button class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        {% if has_prev %}
          <a class="btn btn-outline" href="/clubs/{{ club.id }}/members?page={{ page - 1 }}">← Previous</a>
        {% else %}
          <span></span>
        {% endif %}
        {% if has_next %}
          <a class="btn btn-outline" href="/clubs/{{ club.id }}/members?page={{ page + 1 }}">Next →</a>
        {% endif %}
      </div>
    {% else %}
      <div class="alert alert-info">No members yet.</div>
    {% endif %}
  </section>

{% endblock %}
